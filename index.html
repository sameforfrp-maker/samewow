<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ثبت کار و محاسبه هزینه‌ها — پیشرفته</title>
<style>
  :root{--bg:#0f1724;--card:#1e293b;--accent1:#ff6b6b;--accent2:#ffd194;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{margin:0;font-family:Vazir, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;background:var(--bg);color:#e6eef8;padding:18px;display:flex;flex-direction:column;align-items:center}
  h1{color:var(--accent1);margin:6px 0 18px}
  .wrap{width:100%;max-width:980px}
  form{background:var(--card);padding:14px;border-radius:12px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;align-items:end}
  label{font-size:13px;color:var(--muted);}
  input,select{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:inherit}
  .full{grid-column:1/-1}
  .actions{display:flex;gap:8px}
  button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent1),#ff3b3b);color:#07101a}
  .ghost{background:transparent;color:var(--accent2);border:1px solid rgba(255,255,255,0.04)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center}
  th{background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
  .controls-row{display:flex;gap:8px;align-items:center;margin:12px 0}
  .summary{background:var(--card);padding:10px;border-radius:10px;margin-top:10px;display:flex;justify-content:space-between;gap:10px}
  canvas{background:transparent;border-radius:8px}
  .small-btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer;background:rgba(255,255,255,0.02)}
  .muted{color:var(--muted);font-size:13px}
  @media (max-width:900px){form{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ثبت کار و محاسبه هزینه‌ها — پیشرفته</h1>
  <form id="workForm">
    <div>
      <label>تاریخ</label>
      <input type="date" id="date" required />
    </div>
    <div>
      <label>نوع کار</label>
      <select id="workType" required>
        <option value="FRP">FRP</option>
        <option value="قفل">قفل</option>
        <option value="برنامه">برنامه</option>
        <option value="سایر">سایر</option>
      </select>
    </div>
    <div>
      <label>تعداد / مدت (ساعت یا واحد)</label>
      <input type="number" id="amount" min="0" step="0.1" required />
    </div>

    <div>
      <label>نرخ همکار (به تومان یا واحد)</label>
      <input type="number" id="rate" min="0" step="0.1" required />
    </div>
    <div>
      <label>توضیحات (اختیاری)</label>
      <input type="text" id="desc" placeholder="مثلاً نام مشتری یا جزئیات کوتاه" />
    </div>

    <div class="actions full">
      <button id="submitBtn" type="submit">ثبت کار</button>
      <button id="clearAll" type="button" class="ghost">پاک کردن همه</button>
      <button id="exportCSV" type="button" class="ghost">خروجی CSV</button>
      <button id="importJSON" type="button" class="ghost">بارگذاری JSON</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </form>

  <div class="controls-row">
    <div class="muted">فیلتر تاریخ:</div>
    <input type="date" id="fromDate" />
    <input type="date" id="toDate" />
    <button id="filterBtn" class="small-btn">اعمال فیلتر</button>
    <button id="resetFilter" class="small-btn">حذف فیلتر</button>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="dailyReport" class="small-btn">گزارش روزانه</button>
      <button id="weeklyReport" class="small-btn">گزارش هفتگی</button>
    </div>
  </div>

  <div style="overflow:auto;max-height:300px">
    <table id="workTable">
      <thead>
        <tr><th>تاریخ</th><th>نوع</th><th>تعداد</th><th>نرخ</th><th>کل</th><th>توضیحات</th><th>عملیات</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="summary">
    <div>جمع کل بازه: <strong id="totalCost">0</strong></div>
    <div>تعداد رکورد: <strong id="count">0</strong></div>
  </div>

  <div style="margin-top:14px;display:grid;grid-template-columns:1fr 320px;gap:12px">
    <div style="background:var(--card);padding:12px;border-radius:10px">
      <div style="font-weight:700;margin-bottom:8px">نمودار هزینه‌ها (در بازهٔ انتخابی)</div>
      <canvas id="chart" width="600" height="240"></canvas>
    </div>
    <div style="background:var(--card);padding:12px;border-radius:10px">
      <div style="font-weight:700;margin-bottom:8px">جمع‌بندی سریع</div>
      <div class="muted">هزینه بر حسب نوع کار:</div>
      <div id="byType" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
// داده‌ها در localStorage با کلید workData ذخیره می‌شوند
let workData = JSON.parse(localStorage.getItem('workData')) || [];
const tbody = document.querySelector('#workTable tbody');
const totalCostEl = document.getElementById('totalCost');
const countEl = document.getElementById('count');
const dateInput = document.getElementById('date');
const fromDate = document.getElementById('fromDate');
const toDate = document.getElementById('toDate');

// تاریخ امروز به عنوان پیش‌فرض
dateInput.valueAsDate = new Date();

function save(){ localStorage.setItem('workData', JSON.stringify(workData)); }

function formatCurrency(n){ return Number(n).toLocaleString(); }

function render(filterFn = null){
  tbody.innerHTML = '';
  let total = 0; let count = 0;
  const rows = workData.filter(item => !filterFn || filterFn(item));
  rows.forEach((item, idx) => {
    const tr = document.createElement('tr');
    const cost = +(item.amount || 0) * +(item.rate || 0);
    total += cost; count++;
    tr.innerHTML = `
      <td>${item.date}</td>
      <td>${item.type}</td>
      <td>${item.amount}</td>
      <td>${formatCurrency(item.rate)}</td>
      <td>${formatCurrency(cost.toFixed(2))}</td>
      <td>${item.desc||''}</td>
      <td>
        <button class="small-btn" data-action="edit" data-idx="${idx}">ویرایش</button>
        <button class="small-btn" data-action="delete" data-idx="${idx}">حذف</button>
      </td>`;
    tbody.appendChild(tr);
  });
  totalCostEl.innerText = formatCurrency(total.toFixed(2));
  countEl.innerText = count;
  drawSummary(rows);
  drawChart(rows);
}

// ثبت فرم
const form = document.getElementById('workForm');
form.addEventListener('submit', e => {
  e.preventDefault();
  const data = {
    date: document.getElementById('date').value,
    type: document.getElementById('workType').value,
    amount: parseFloat(document.getElementById('amount').value) || 0,
    rate: parseFloat(document.getElementById('rate').value) || 0,
    desc: document.getElementById('desc').value || ''
  };
  workData.push(data);
  save();
  render();
  form.reset();
  dateInput.valueAsDate = new Date();
});

// مدیریت ویرایش و حذف
tbody.addEventListener('click', e => {
  const btn = e.target.closest('button'); if(!btn) return;
  const action = btn.dataset.action; const idx = parseInt(btn.dataset.idx,10);
  if(action === 'delete'){
    if(confirm('مطمئنی می‌خوای این رکورد حذف بشه؟')){ workData.splice(idx,1); save(); render(); }
  } else if(action === 'edit'){
    const item = workData[idx];
    // پر کردن فرم برای ویرایش
    document.getElementById('date').value = item.date;
    document.getElementById('workType').value = item.type;
    document.getElementById('amount').value = item.amount;
    document.getElementById('rate').value = item.rate;
    document.getElementById('desc').value = item.desc;
    // حذف رکورد فعلی تا زمانی که دوباره ثبت شود
    workData.splice(idx,1);
    save(); render();
    window.scrollTo({top:0,behavior:'smooth'});
  }
});

// فیلترها
document.getElementById('filterBtn').addEventListener('click', ()=>{
  const from = fromDate.value ? new Date(fromDate.value) : null;
  const to = toDate.value ? new Date(toDate.value) : null;
  render(item => {
    const d = new Date(item.date);
    if(from && d < from) return false;
    if(to && d > to) return false;
    return true;
  });
});

document.getElementById('resetFilter').addEventListener('click', ()=>{ fromDate.value=''; toDate.value=''; render(); });

// گزارش روزانه / هفتگی
function groupByDay(data){
  const map = {};
  data.forEach(it=>{
    map[it.date] = (map[it.date]||0) + (it.amount * it.rate);
  });
  return Object.entries(map).map(([k,v])=>({label:k,value:v})).sort((a,b)=>new Date(a.label)-new Date(b.label));
}

document.getElementById('dailyReport').addEventListener('click', ()=>{
  const rows = workData.slice();
  const grouped = groupByDay(rows);
  alert('گزارش روزانه ساخته شد — نمودار بروزرسانی شد.');
  drawChartFromGrouped(grouped);
});

document.getElementById('weeklyReport').addEventListener('click', ()=>{
  const map = {};
  workData.forEach(it=>{
    const d = new Date(it.date);
    // هفته‌ی سال
    const start = new Date(d); start.setDate(d.getDate() - d.getDay());
    const key = start.toISOString().slice(0,10);
    map[key] = (map[key]||0) + (it.amount * it.rate);
  });
  const grouped = Object.entries(map).map(([k,v])=>({label:'week of '+k,value:v})).sort((a,b)=>a.label.localeCompare(b.label));
  alert('گزارش هفتگی ساخته شد — نمودار بروزرسانی شد.');
  drawChartFromGrouped(grouped);
});

// نمودار ساده با canvas
const chartCanvas = document.getElementById('chart');
const ctx = chartCanvas.getContext('2d');

function clearCanvas(){ ctx.clearRect(0,0,chartCanvas.width,chartCanvas.height); }

function drawChart(rows){
  const grouped = groupByDay(rows);
  drawChartFromGrouped(grouped);
}

function drawChartFromGrouped(groups){
  clearCanvas();
  if(!groups || groups.length===0) return;
  // اندازه گیری
  const padding = 30; const w = chartCanvas.width; const h = chartCanvas.height;
  const max = Math.max(...groups.map(g=>g.value));
  const stepX = (w - padding*2) / Math.max(1, groups.length-1);
  // محور X labels
  ctx.fillStyle = '#fff'; ctx.font='12px sans-serif';
  // draw line
  ctx.beginPath();
  groups.forEach((g,i)=>{
    const x = padding + i*stepX; const y = h - padding - (g.value / max) * (h - padding*2);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#ff6b6b'; ctx.lineWidth = 3; ctx.stroke();
  // draw points and labels
  groups.forEach((g,i)=>{
    const x = padding + i*stepX; const y = h - padding - (g.value / max) * (h - padding*2);
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fillStyle='#ffb347'; ctx.fill();
    ctx.fillStyle='#cbd5e1'; ctx.fillText(g.label.slice(0,10), x-20, h - 8);
  });
}

// جمع‌بندی بر حسب نوع کار
function drawSummary(rows){
  const map = {};
  rows.forEach(it=>{ map[it.type] = (map[it.type]||0) + (it.amount*it.rate); });
  const container = document.getElementById('byType'); container.innerHTML='';
  Object.entries(map).forEach(([k,v])=>{
    const div = document.createElement('div'); div.innerText = `${k}: ${formatCurrency(v.toFixed(2))}`; container.appendChild(div);
  });
}

// حذف همه
document.getElementById('clearAll').addEventListener('click', ()=>{
  if(confirm('همهٔ داده‌ها پاک شوند؟')){ workData = []; save(); render(); }
});

// خروجی CSV
function toCSV(rows){
  const header = ['date','type','amount','rate','desc'];
  const lines = [header.join(',')];
  rows.forEach(r=>{ lines.push([r.date,r.type,r.amount,r.rate,`"${(r.desc||'').replace(/"/g,'""') }"`].join(',')); });
  return lines.join('\n');
}

document.getElementById('exportCSV').addEventListener('click', ()=>{
  const csv = toCSV(workData);
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'work-data.csv'; a.click(); URL.revokeObjectURL(url);
});

// وارد کردن JSON
const fileInput = document.getElementById('fileInput');
document.getElementById('importJSON').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const parsed = JSON.parse(ev.target.result);
      if(Array.isArray(parsed)){
        workData = parsed.concat(workData);
        save(); render();
        alert('JSON با موفقیت وارد شد.');
      } else alert('فایل باید آرایه‌ای از رکوردها باشد.');
    } catch(err){ alert('خطا در خواندن فایل JSON'); }
  };
  reader.readAsText(f);
});

// مقداردهی اولیه
render();

</script>
</body>
</html>
